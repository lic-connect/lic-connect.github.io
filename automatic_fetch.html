<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Automatic Fetch</title>
<!-- PWA: Link to the Manifest File -->
<link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
/* ✅ Import a modern font */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root {
        --modern-blue: #0866FF; /* Modern Facebook Blue */
        --light-blue-bg: #f0f2f5; /* Light grey-blue for background */
        --text-dark: #1c1e21; /* Dark grey for text */
        --text-light: #65676b;
        --border-color: #dddfe2;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--light-blue-bg);
        padding: 40px 20px;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center; /* Center vertically */
        min-height: 100vh;
    }
    
    .container {
        background: #fff;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
        text-align: center;
        border-top: 5px solid var(--modern-blue); /* Accent border */
    }
    
    .container h2 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--modern-blue);
        margin-bottom: 25px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-light);
        text-align: left; /* Align label to the left */
    }

    /* Modern Input with Icon */
    .input-wrapper {
        position: relative;
        margin-bottom: 20px;
    }
    .input-wrapper i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--border-color);
        font-size: 1.2rem;
    }
    input[type="text"] {
        width: 100%;
        padding: 15px 15px 15px 50px; /* Space for icon */
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 1.1rem;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }
    input[type="text"]:focus {
        outline: none;
        border-color: var(--modern-blue);
        box-shadow: 0 0 0 3px rgba(8, 102, 255, 0.2);
    }
    input[type="text"]:focus + i {
        color: var(--modern-blue);
    }

    /* Flamboyant Button Style */
    button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 16px;
        margin-bottom: 15px;
        border: none;
        border-radius: 10px;
        background-color: var(--modern-blue);
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(8, 102, 255, 0.3);
    }
    button i {
        margin-right: 10px;
    }
    button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(8, 102, 255, 0.4);
    }

    /* Stylish Result Box */
    #result {
        margin-top: 30px;
        padding: 0;
        border: none;
        background-color: transparent;
        text-align: left;
    }
    #result p {
        background-color: #f0f2f5;
        padding: 12px 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid var(--modern-blue);
    }
    #result hr {
        display: none; /* Hide the old horizontal lines */
    }
    .error-message {
        color: #d93025;
        font-weight: 600;
        background-color: #fbe9e7 !important;
        border-left: 4px solid #d93025 !important;
    }
    .success-message strong {
        color: var(--modern-blue);
        display: block; /* Makes the label and value appear on two lines */
        font-size: 0.8rem;
        margin-bottom: 2px;
        text-transform: uppercase;
    }

   .home-button-container {
      position: fixed;
      top: 20px;
      right: 25px;
      z-index: 1000;
    }

    .home-button-container a img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }

    .home-button-container a:hover img {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Automatic Fetch</h2>
    <label for="policyNo">Enter Policy Number</label>
    <input type="text" id="policyNo" placeholder="e.g. 987654321" />
    <button onclick="fetchPolicyholder()">Fetch Details</button>
    <div id="result"></div>
  </div>

  <script>
    // Ensure these are your actual Supabase project credentials
    const supabaseUrl = 'https://efduqdondmlzmwhfgkfz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZHVxZG9uZG1sem13aGZna2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDcxNjUsImV4cCI6MjA2NDM4MzE2NX0.M-D0eUjlCxc-vZtT3LdbWJJgLDZ-ScHQkZH69kU6d44';

    // Corrected Supabase client initialization:
    // 'supabase' here refers to the global object loaded by the CDN script
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    async function fetchPolicyholder() {
      const policyNoInput = document.getElementById('policyNo');
      const policyNo = policyNoInput.value.trim();
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = ''; // Clear previous results

      if (!policyNo) {
        resultDiv.innerHTML = '<p class="error-message">❌ Please enter a policy number.</p>';
        return;
      }

      console.log('Attempting to fetch for Policy Number:', policyNo);

      try {
        // IMPORTANT: Double-check the exact column name in your Supabase table.
        // It might be 'policy_number' (lowercase) if you didn't use quotes when creating it.
        const { data, error } = await supabaseClient
          .from('automatic_fetch') // Ensure this table name is correct
        .select('policyholder_name, agents_name, agency_code, agents_address, agents_mobile_number, agents_email_id, agency_status, remarks') // New version // Ensure these column names are correct
          .eq('Policy_number', policyNo) // <-- CRITICAL: Verify 'Policy_number' or 'policy_number'
          .single(); // .single() expects exactly one row or it throws an error

        console.log('Supabase Query Result - Data:', data);
        console.log('Supabase Query Result - Error:', error);

        if (error) {
          // .single() will produce an error if 0 or >1 rows are found.
          // Common error code for no rows with .single() is 'PGRST116'.
          let errorMessage = '❌ An error occurred while fetching data.';
          if (error.code === 'PGRST116' || (error.message && error.message.toLowerCase().includes("no rows returned")) ) {
            errorMessage = '❌ No data found for this policy number.';
          } else if (error.message) {
            errorMessage = `❌ Error: ${error.message}`;
          }
          resultDiv.innerHTML = `<p class="error-message">${errorMessage}</p>`;
          console.error('Supabase error details:', error);
        } else if (!data) {
          // This case might be redundant if .single() always populates 'error' when no data is found.
          // However, it's a good fallback.
          resultDiv.innerHTML = '<p class="error-message">❌ No data found for this policy number (data object is null).</p>';
        } else {
          resultDiv.innerHTML = `
         
            <p class="success-message"><strong>Policyholder Name:</strong> ${data.policyholder_name || 'N/A'}</p>
            <hr>
            <p class="success-message"><strong>Agent Name:</strong> ${data.agents_name || 'N/A'}</p>
            <p class="success-message"><strong>Agency Code:</strong> ${data.agency_code || 'N/A'}</p>
            <p class="success-message"><strong>Agency Status:</strong> ${data.agency_status || 'N/A'}</p>
            <p class="success-message"><strong>Agent's Address:</strong> ${data.agents_address || 'N/A'}</p>
            <p class="success-message"><strong>Agent's Mobile:</strong> ${data.agents_mobile_number || 'N/A'}</p>
            <p class="success-message"><strong>Agent's Email:</strong> ${data.agents_email_id || 'N/A'}</p>
            <hr>
            <p class="success-message"><strong>Remarks:</strong> ${data.remarks || 'N/A'}</p>
          `;
        }
      } catch (catchError) {
        // Catch any unexpected errors during the async operation or from .single()
        console.error('Caught an unexpected error:', catchError);
        resultDiv.innerHTML = `<p class="error-message">❌ An unexpected error occurred: ${catchError.message}</p>`;
      }
    }
  </script>
<div class="home-button-container">
  <a href="/main.html" title="Go to Home">
    <img src="images/home-icon.png" alt="Home">
  </a>
</div>
<!-- PWA: Register the Workbox Service Worker -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw-workbox.js')
                .then(registration => {
                    console.log('Workbox service worker registered successfully:', registration);
                })
                .catch(error => {
                    console.error('Workbox service worker registration FAILED:', error);
                });
        });
    }
</script>  
</body>
</html>